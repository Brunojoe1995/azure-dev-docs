# Using Azure Export in Advanced Scenarios
This article explains how to append resources to existing Terraform environments as well as export resources into an existing Terraform environment with a remote backend state. It concludes with an example workflow.

## Appending to Existing Resources
When exporting, `aztfexport` will by default ensure the output directory is empty. This is to avoid any conflicts happen for existing user files, including the terraform configuration, provider configuration, the state file, etc. As a result, `aztfexport` generates a new workspace for users.

If you instead wish to import resources to an existing state file via `aztfexport`, use the `--append` option. 
```console
aztfexport [command] --append <scope>
```
When this option is run, `aztfexport` will check if there is a preexisting `provider` and `terraform` block (and create a file for each respectively if either does not exist). Then it proceeds with exporting.

This means that if the output directory has a state file, any resource exported by `aztfexport` will be imported into the state file. Furthermore, the file generated by `aztfexport` in this case will have a `.aztfexport` suffix before the extension (e.g. `main.aztfexport.tf`), to avoid potential file name conflicts. If you run `aztfexport --append` multiple times, the generated config in `main.aztfexport.tf` will append to itself in each run.
## Bring Your Own Terraform Config
By default `aztfexport` uses a local backend to store the state file, but it is also possible to use a remote backend. Azure Export for Terraform enables you to define your own `terraform` or `provider` blocks to pass in. Simply define these in a `.tf` file within your target directory, export with the `--append` flag enabled, and your config will export to the specified backend and provider version (if it's provided). Be aware that your provider version should match the `aztfexport` version of AzureRM when exporting or the command will fail.
### Azure Storage Example
This example is based on the [tutorial on storing Terraform state in Azure storage](https://learn.microsoft.com/en-us/azure/developer/terraform/store-state-in-azure-storage?tabs=azure-cli):
```
terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~>3.0"
    }
  }
    backend "azurerm" {
        resource_group_name  = "tfstate"
        storage_account_name = "storageacc"
        container_name       = "tfstate"
        key                  = "terraform.tfstate"
    }

}

provider "azurerm" {
  features {}
}
```

### Terraform Cloud Example
```terraform
terraform {
  cloud {
    organization = "aztfexport-test"
    workspaces {
      name = "aztfexport-playground"
    }
  }
  required_providers {
    azurerm = {
      source = "hashicorp/azurerm"
      version = "~>3.0"
    }
  }
}
provider "azurerm" {
  features {
  }
}
```
### Inline Experience
To export to a backend inline, use the `--backend-type` and `--backend-config` options. Refer to the [Terraform backend documentation](https://www.terraform.io/language/settings/backends) to identify your type and config values.

For our example of an Azure storage account, you'll need your resource group name, storage account name, and container name as has been defined by [the AzureRM backend documentation](https://www.terraform.io/language/settings/backends/azurerm#azurerm). Pass these into the command along with your backend type:

```shell
aztfexport [subcommand] --backend-type=azurerm --backend-config=resource_group_name=<resource group name> --backend-config=storage_account_name=<account name> --backend-config=container_name=<container name> --backend-config=key=terraform.tfstate 
```
> ðŸ’¡ Note that if the backend state already exists, `aztfexport` will merge the new resources to the existing state automatically. You do not need to specify the `--append` option inline.

## Export Azure Resources to an Existing Terraform Environment
To put it all together, for this example we simulate a scenario in which new resources have been created outside of Terraform that need to be moved into Terraform management. To complete the  section, make sure you have a backend setup. This tutorial uses the same setup that is specified in the [Azure storage remote state tutorial](https://learn.microsoft.com/en-us/azure/developer/terraform/store-state-in-azure-storage?tabs=terraform).

We use the `--hcl-only` flag to export the configured resources to HCL in a temp directory, and the `-o` flag to specify and create the directory if it does not yet exist.:
```console
aztfexport res -o tempdir --hcl-only <Resource ID>
```

After we inspect and determine the resource can be appended, we utilize the generated [mapping file] and the `--append` flag to ensure Azure Export respects the preexisting remote state and provider versions within our existing environment:
```console
aztfexport map --append `./tempdir/aztfexportResourceMapping.json`
```
After which we run `terraform init` and `terraform plan` on the directory. If the terminal says `"No changes needed"` then congratulations! Your infrastructure and its corresponding state have been succesfully appended to your Terraform environment.

If your plan runs into issues, you should first visit [this page] to understand limitations around deploying code generated by `--hcl-only`. If it does not solve your problem, open a [GitHub issue](https://github.com/Azure/aztfexport/issues).

## Summary
In this article you learned how to export to existing environments, both for local and remote backends. You also learned how to bring your own Terraform config to be used by Azure Export for Terraform.