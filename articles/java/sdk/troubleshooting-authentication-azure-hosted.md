---
title: Troubleshooting Azure-hosted applications authentication
description: An overview of how to troubleshoot Azure-hosted authentication issues
ms.date: 08/16/2023
ms.topic: conceptual
ms.custom: devx-track-java, devx-track-extended-java
author: KarlErickson
ms.author: jogiles
---

# Troubleshooting Azure-hosted applications authentication

This troubleshooting document provides guidance on dealing with issues encountered when authenticating Azure SDK for Java applications hosted on Azure, through various `TokenCredential` implementations. For more information, see the [conceptual documentation on Azure-hosted credential types](identity-azure-hosted-auth.md).

## Troubleshooting DefaultAzureCredential

| Error message                                                                                                                           | Description                                                                                                                                                                                                                                                                                                                      | Mitigation                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|-----------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `CredentialUnavailableException raised with message "DefaultAzureCredential failed to retrieve a token from the included credentials."` | All credentials in `DefaultAzureCredential` chain failed to retrieve a token, each throwing a `CredentialUnavailableException`                                                                                                                                                                                               | * [Enable logging][logging_link] to verify the credentials being tried, and get further diagnostic information. <br>* For more information, see the troubleshooting guide for the underlying credential types. <br>* [EnvironmentCredential](#troubleshooting-environmentcredential) <br>* [ManagedIdentityCredential](#troubleshooting-managedidentitycredential) <br>* [VisualStudioCodeCredential](troubleshooting-authentication-dev-env.md#troubleshooting-visualstudiocodecredential) <br>* [AzureCLICredential](troubleshooting-authentication-dev-env.md#troubleshooting-azureclicredential) <br>* [AzurePowershellCredential](troubleshooting-authentication-dev-env.md#troubleshooting-azurepowershellcredential) |
| `HttpResponseException raised from the client with a status code of 401 or 403`                                                         | Authentication succeeded but the authorizing Azure service responded with a 401 (Authenticate), or 403 (Forbidden) status code. This issue is often caused by `DefaultAzureCredential` authenticating an account other than the intended or that the intended account doesn't have the correct permissions or roles assigned. | * [Enable logging][logging_link] to determine which credential in the chain returned the authenticating token. <br>* In the case where a credential other than the expected one is returning a token, look to bypass this issue by signing out of the corresponding development tool. <br>* Ensure that the correct role is assigned to the account being used. For example, a service specific role rather than the subscription Owner role.                                                                                                                                                                                                                                                                                             |

## Troubleshooting EnvironmentCredential

When using the `EnvironmentCredential`, you may optionally try/catch for `CredentialUnavailableException`. The following table shows the errors that this exception indicates, and methods of mitigation:

| Error message                                  | Description                                                | Mitigation                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|--------------------------------------------------|----------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `Environment variables aren't fully configured.` | A valid combination of environment variables wasn't set. | Ensure the appropriate environment variables are set **prior to application startup** for the intended authentication method, as described in the following list: <br>* To authenticate a service principal using a client secret, ensure the variables `AZURE_CLIENT_ID`, `AZURE_TENANT_ID` and `AZURE_CLIENT_SECRET` are properly set. <br>* To authenticate a service principal using a certificate, ensure the variables `AZURE_CLIENT_ID`, `AZURE_TENANT_ID`, `AZURE_CLIENT_CERTIFICATE_PATH` and optionally `AZURE_CLIENT_CERTIFICATE_PASSWORD` are properly set. <br>* To authenticate a user using a password, ensure the variables `AZURE_USERNAME` and `AZURE_PASSWORD` are properly set. |

## Troubleshooting ManagedIdentityCredential

The `ManagedIdentityCredential` is designed to work on various Azure hosts that provide managed identity. Configuring the managed identity and troubleshooting failures varies from host to host. The following list shows the Azure host environments that you can assign a managed identity and that `ManagedIdentityCredential` supports:

* Azure App Service and Azure Functions - [configuration](/azure/app-service/overview-managed-identity) - [troubleshooting](#azure-app-service-and-azure-functions-managed-identity)
* Azure Arc - [configuration](/azure/azure-arc/servers/managed-identity-authentication)
* Azure Kubernetes Service - [configuration](https://azure.github.io/aad-pod-identity/docs/) - [troubleshooting](#azure-kubernetes-service-managed-identity)
* Azure Service Fabric  -[configuration](/azure/service-fabric/concepts-managed-identity)
* Azure Virtual Machines and Scale Sets  -[configuration](/azure/active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm) - [troubleshooting](#azure-virtual-machine-managed-identity)

### Azure Virtual Machine Managed Identity

When using the `ManagedIdentityCredential`, you may optionally try/catch for `CredentialUnavailableException`. The following table shows the errors that this exception indicates, and methods of mitigation:

| Error message                                                                    | Description                                                                                                        | Mitigation                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|----------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `The requested identity hasn't been assigned to this resource.`                  | The IMDS endpoint responded with a status code of 400, indicating the requested identity isn't assigned to the VM. | If using a user assigned identity, ensure the specified `clientId` is correct.<p/><p/>If using a system assigned identity, make sure it has been enabled properly. Instructions to enable the system assigned identity on an Azure VM can be found [here](/azure/active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm#enable-system-assigned-managed-identity-on-an-existing-vm).                                                                                                                                                  |
| `The request failed due to a gateway error.`                                     | The request to the IMDS endpoint failed due to a gateway error, 502 or 504 status code.                            | IMDS doesn't support calls via proxy or gateway. Disable proxies or gateways running on the VM for calls to the IMDS endpoint `http://169.254.169.254/`                                                                                                                                                                                                                                                                                                                                                                                                      |
| `No response received from the managed identity endpoint.`                       | No response was received for the request to IMDS or the request timed out.                                         | * Ensure managed identity has been properly configured on the VM. Instructions for configuring the manged identity can be found [here](/azure/active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm). <br>* Verify the IMDS endpoint is reachable on the VM. See [the next section](#verify-that-imds-is-available-on-the-vm) for instructions.                                                                                                                                                                                   |
| `Multiple attempts failed to obtain a token from the managed identity endpoint.` | Retries to retrieve a token from the IMDS endpoint have been exhausted.                                            | * For more information on specific failures, see the inner exception messages. If the data has been truncated, more detail can be obtained by [collecting logs][logging_link]. <br>* Ensure managed identity has been properly configured on the VM. Instructions for configuring the managed identity can be found [here](/azure/active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm). <br>* Verify the IMDS endpoint is reachable on the VM. See [the next section](#verify-that-imds-is-available-on-the-vm) for instructions. |

#### Verify that IMDS is available on the VM

If you have access to the VM, you can verify the manged identity endpoint is available via the command line using curl.

```bash
curl 'http://169.254.169.254/metadata/identity/oauth2/token?resource=https://management.core.windows.net&api-version=2018-02-01' -H "Metadata: true"
```

> [!WARNING]
> The output of this command contains a valid access token. To avoid compromising account security, do not share this access token.

### Azure App Service and Azure Functions Managed Identity

When using the `ManagedIdentityCredential`, you may optionally try/catch for `CredentialUnavailableException`. The following table shows the errors that this exception indicates, and methods of mitigation:

| Error message                                           | Description                                                                    | Mitigation                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|---------------------------------------------------------|--------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `ManagedIdentityCredential authentication unavailable.` | The environment variables configured by the App Services host weren't present. | * Ensure the managed identity has been properly configured on the App Service. Instructions for configuring the managed identity can be found [here](/azure/app-service/overview-managed-identity?tabs=dotnet). <br>* Verify the App Service environment is properly configured and the managed identity endpoint is available. See [the next section](#verify-the-app-service-managed-identity-endpoint-is-available) for instructions. |

#### Verify the App Service Managed Identity endpoint is available

If you have access to SSH into the App Service, you can verify that managed identity is available in the environment. First ensure the environment variables `MSI_ENDPOINT` and `MSI_SECRET` have been set in the environment. Then you can verify the managed identity endpoint is available using curl.

```bash
curl 'http://169.254.169.254/metadata/identity/oauth2/token?resource=https://management.core.windows.net&api-version=2018-02-01' -H "Metadata: true"
```

> [!WARNING]
> The output of this command contains a valid access token. To avoid compromising account security, do not share this access token.

### Azure Kubernetes Service Managed Identity

#### Pod Identity for Kubernetes

When using the `ManagedIdentityCredential`, you may optionally try/catch for `CredentialUnavailableException`. The following table shows the errors that this exception indicates, and methods of mitigation:

| Error message                        | Description                                                                          | Mitigation                                                                                                                                                                                                                                                                                                                                                                      |
|------------------------------------- |--------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `No Managed Identity endpoint found` | The application attempted to authenticate before an identity was assigned to its pod | Verify the pod is labeled correctly. This problem also occurs when a correctly labeled pod authenticates before the identity is ready. To prevent initialization races, configure NMI to set the Retry-After header in its responses (see [Pod Identity documentation](https://azure.github.io/aad-pod-identity/docs/configure/feature_flags/#set-retry-after-header-in-nmi-response)). |

## Troubleshooting WorkloadIdentityCredential

When using the `WorkloadIdentityCredential`, you may optionally try/catch for `CredentialUnavailableException`. The following table shows the errors that this exception indicates, and methods of mitigation:

| Error message                                                                                           | Description                                                                                                                       | Mitigation                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|---------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `WorkloadIdentityCredential authentication unavailable. The workload options are not fully configured.` | The `WorkloadIdentityCredential` requires `clientId`, `tenantId` and `tokenFilePath` to authenticate with Microsoft Entra ID. | If you're using `DefaultAzureCredential`, then: <br>* Ensure client ID is specified via `workloadIdentityClientId` setter or the `AZURE_CLIENT_ID` environment variable. <br>* Ensure tenant ID is specified via `AZURE_TENANT_ID` environment variable. <br>* Ensure that you've specified the token file path via the `AZURE_FEDERATED_TOKEN_FILE` environment variable. <br>* Ensure authority host is specified via the `AZURE_AUTHORITY_HOST` environment variable. <br>If you're using `WorkloadIdentityCredential`, then: <br>* Ensure tenant ID is specified via `tenantId` setter on credential builder or the `AZURE_TENANT_ID` environment variable. <br>* Ensure client ID is specified via `clientId` setter on the credential builder or the `AZURE_CLIENT_ID` environment variable. <br>* Ensure token file path is specified via `tokenFilePath` setter on the credential builder or `AZURE_FEDERATED_TOKEN_FILE` environment variable. <br>* Consult the [product troubleshooting guide](https://azure.github.io/azure-workload-identity/docs/troubleshooting.html) for other issues. |

## Next steps

If the troubleshooting guidance in this article doesn't help to resolve issues when using the Azure SDK for Java client libraries, we recommended that you reach out to the development team by [filing an issue](https://github.com/Azure/azure-sdk-for-java/issues/new/choose) in the [Azure SDK for Java GitHub repository](https://github.com/Azure/azure-sdk-for-java).

<!-- LINKS -->
[logging_link]: troubleshooting-authentication-overview.md#enable-and-configure-logging